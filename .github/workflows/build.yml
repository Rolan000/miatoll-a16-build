name: Build Evolution X A16 (Miatoll)

on:
  workflow_dispatch: # Ручной запуск

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    # 1. ОЧИСТКА ДИСКА
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 8192
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout
      uses: actions/checkout@v4

    # 2. УСТАНОВКА ПАКЕТОВ
    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git git-lfs gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3

    # 3. НАСТРОЙКА REPO
    - name: Install Repo
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "MiatollBuilder"
        git config --global user.email "bot@example.com"

    # 4. ИНИЦИАЛИЗАЦИЯ (Ветка bq1, как ты просил для Repo Init)
    - name: Initialize Repo
      run: |
        mkdir workspace
        cd workspace
        repo init -u https://github.com/Evolution-X/manifest -b bq1 --depth=1

    # 5. LOCAL MANIFEST (Твои ссылки на деревья)
    - name: Create Local Manifest
      run: |
        cd workspace
        mkdir -p .repo/local_manifests
        
        cat <<EOF > .repo/local_manifests/roomservice.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
            <!-- Device Trees -->
            <project path="device/xiaomi/miatoll" name="Miatoll720G/device_xiaomi_miatoll" remote="github" revision="los" />
            <project path="device/xiaomi/sm6250-common" name="Miatoll720G/device_xiaomi_sm6250-common" remote="github" revision="los" />
            
            <!-- Vendor Trees -->
            <project path="vendor/xiaomi/miatoll" name="Miatoll720G/vendor_xiaomi_miatoll" remote="github" revision="los" />
            <project path="vendor/xiaomi/sm6250-common" name="Miatoll720G/vendor_xiaomi_sm6250-common" remote="github" revision="los" />
            
            <!-- Kernel Tree -->
            <project path="kernel/xiaomi/sm6250" name="Miatoll720G/kernel_sm6250" remote="github" revision="16" />
            
            <!-- Hardware Trees -->
            <project path="hardware/xiaomi" name="LineageOS/android_hardware_xiaomi" remote="github" revision="lineage-23.0" />
            <project path="hardware/sony/timekeep" name="LineageOS/android_hardware_sony_timekeep" remote="github" revision="lineage-22.2" />
            
            <!-- Extra (Camera & Viper) -->
            <project path="vendor/xiaomi/miuicamera-miatoll" name="Miatoll720G/vendor_xiaomi_miuicamera-miatoll" remote="github" revision="16" />
            <project path="packages/apps/ViPER4AndroidFX" name="Miatoll720G/packages_apps_ViPER4AndroidFX" remote="github" revision="v4a" />
        </manifest>
        EOF

    # 6. СКАЧИВАНИЕ
    - name: Repo Sync
      run: |
        cd workspace
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    # 7. СБОРКА (Здесь версия bp3a, как ты требовал для lunch)
    - name: Build ROM
      run: |
        cd workspace
        . build/envsetup.sh
        # Используем bp3a в таргете
        lunch evolution_miatoll-bp3a-userdebug
        m evolution

    # 8. ЗАГРУЗКА
    - name: Upload ROM
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: workspace/out/target/product/miatoll/EvolutionX*.zip
        name: Evolution X A16 Miatoll
        tag_name: ${{ github.run_id }}
        body: "Manifest: bq1 | Target: bp3a"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
